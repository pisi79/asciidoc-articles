<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.6" />
<title>Sulle spalle dei giganti - Gestione della persistenza</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Sulle spalle dei giganti - Gestione della persistenza</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Tecniche di Object Relational Mapping (ORM) basate sulle specifiche <strong>JPA2</strong> e implementazione basata su <strong>Hibernate</strong>, con  transazionalità gestita a default dal container applicativo.</p></div>
<div class="paragraph"><p>Gestione dell&#8217;accesso fortemente concorrente ai dati mediante tecniche di lock pessimistico o ottimistico delle righe (con versionamento del dato).</p></div>
<div class="paragraph"><p>Possibilità di introdurre logiche custom di apertura e chiusura delle transazioni, nonché coordinamento di transazioni distribuite con basi dati di tipo <strong>XA</strong>.</p></div>
<div class="paragraph"><p>Utilizzo di accesso diretto al dato con query SQL native e/o basate sulle specifiche <strong>JDBC</strong>, per ottenere espressività, efficienza e/o gestione di scenari di inserimento/modifiche di tipo bulk.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_il_nostro_tocco_8230">Il nostro tocco&#8230;</h2>
<div class="sectionbody">
<div class="paragraph"><p>Analogamente a quanto fatto per le armature base (<em>"Controller"</em>) dei componenti <strong>JSF</strong>, abbiamo sviluppato un insieme di armature base (dette <em>"Repository"</em>) per gestire l&#8217;associazione dei Data Access Object (DAO) di tipo <strong>EJB Stateless Session Bean</strong> ai diversi tipo di dato, mappati come <strong>EJB Entity Bean</strong>. L&#8217;integrazione reciproca di tali componenti e' stata resa immediata grazie alle logiche portate a fattore comune dalle classi base di entrambi i tipi.</p></div>
<div class="paragraph"><p>L&#8217;utilizzo combinato dei nostri componenti di tipo <em>Repository</em> e <em>Controller</em> permette l&#8217;adozione di pattern di ricerca e filtraggio dei dati tali da permettere lo scambio efficace dei criteri di filtro tra pagine web, controller jsf e repository ejb. L&#8217;oggetto di ricerca contiene istanze di esempio del tipo di dato da cercare, con i vari campi valorizzabili direttamente dalle maschere, per ricerche di tipo match diretto e ricerca con range.
L&#8217;uso di tale oggetto ricerca all&#8217;interno del repository può essere ricondotto a i criteria di <strong>JPA2</strong>, all&#8217;uso di query <strong>EJBQL</strong> o persino query native.</p></div>
<div class="paragraph"><p>In particolare, sono state portate a fattor comune la costruzione di query per l&#8217;uso di questo oggetto al fine di query di conteggio, query di selezione e raggruppamento (es: per reportistica o graficazione di valori).</p></div>
<div class="paragraph"><p>Ciascuno specifico componente di tipo Repository può infine ovviamente introdurre customizzazioni di tale meccanismo per gestire casistitiche quali uso di flag per ricerche di sottoinsiemi di dati, uso di query innestate, gestione di conversioni e/o semantiche di ricerca specifiche di un particolare oggetto.</p></div>
<div class="sect2">
<h3 id="_gestione_della_persistence_unit_in_uso">Gestione della Persistence Unit in uso</h3>
<div class="paragraph"><p>Il componente generico, presente nelle librerie in uso in diversi progetti, prevede un metodo getter astratto, che utilizza al proprio interno per l&#8217;accesso all&#8217;effettivo gestore della persistenza.</p></div>
<div class="listingblock">
<div class="title">AbstractRepository.java</div>
<div class="content">
<pre><tt>public abstract class AbstractRepository&lt;T&gt;
{

        protected abstract EntityManager getEm();

        ...
}</tt></pre>
</div></div>
<div class="paragraph"><p>In ciascuno specifico applicativo realizzato, e' presente
un&#8217;unica classe (per ogni persistence unit), sempre generica e astratta, utilizzata per iniettare tale dipendenza estendendo l&#8217;armatura generica.</p></div>
<div class="listingblock">
<div class="title">BaseRepository.java</div>
<div class="content">
<pre><tt>public abstract class BaseRepository&lt;T&gt; extends AbstractRepository&lt;T&gt;
{

        @PersistenceContext(unitName = "actualPersistenceUnit")
        protected EntityManager em;

        @Override
        protected EntityManager getEm()
        {
                return em;
        }

}</tt></pre>
</div></div>
<div class="paragraph"><p>Le attuali classi <em>Repository</em>, realizzate ed utilizzate in accordo al pattern DAO, estendendono la classe base del proprio progetto e accedono al gestore della persistenza
attraverso il metodo getter ereditato, laddove abbiano necessita' di sovrascrivere o aggiungere metodi all&#8217;armatura generica.</p></div>
<div class="listingblock">
<div class="title">OrderRepository.java</div>
<div class="content">
<pre><tt>public abstract class OrderRepository extends BaseRepository&lt;Order&gt;
{

        @Override
        public Order customMethod(String... params)
        {
                try
                {
                        return (Order) getEm().createQuery(... do something ...).getSingleResult();
                }
                catch ( Exception e )
                {
                        logger.error(e.getMessage(),e);
                        return null;
                }
        }

        ...

}</tt></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_logica_c_r_u_d">Logica C.R.U.D.</h3>
<div class="paragraph"><p>L&#8217;armatura generica implementa i tipici metodi di creazione / lettura / modifica / eliminazione richiamati dal controller del tipo di dato corrispondente.</p></div>
<div class="paragraph"><p>Laddove necessario, il comportamento preliminare o effettivo di ogni metodo puo' essere esteso o ridefinito dai Repository specifici di un particolare dato.</p></div>
<div class="listingblock">
<div class="title">AbstractRepository.java</div>
<div class="content">
<pre><tt>        ...

        @SuppressWarnings("unchecked")
        protected Class&lt;T&gt; getEntityType()
        {
                ParameterizedType parameterizedType = (ParameterizedType) getClass()
                        .getGenericSuperclass();
                return (Class&lt;T&gt;) parameterizedType.getActualTypeArguments()[0];
        }

        // CREATE

        public T create(Class&lt;T&gt; domainClass)
        {
                try
                {
                        return domainClass.newInstance();
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return null;
                }
        }

        public T persist(T object)
        {
                try
                {
                        object = prePersist(object);
                        if (object != null)
                        {
                                getEm().persist(object);
                        }
                        return object;
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return null;
                }
        }

        /**
        * Override this if needed
        */
        protected T prePersist(T object)
        {
                return object;
        }

        // READ

        public T find(Object key)
        {
                try
                {
                        return getEm().find(getEntityType(), key);
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return null;
                }
        }


        /**
        * Override this if needed
        */
        public T fetch(Object key)
        {
                try
                {
                        return getEm().find(getEntityType(), key);
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return null;
                }
        }

        // UPDATE

        public boolean update(T object)
        {
                try
                {
                        object = preUpdate(object);
                        getEm().merge(object);
                        return true;
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return false;
                }
        }

        /**
        * Override this if needed
        */
        protected T preUpdate(T object)
        {
                return object;
        }

        // DELETE

        public boolean delete(Object key)
        {
                try
                {
                        T obj = getEm().find(getEntityType(), key);
                        obj = preDelete(obj);
                        if (obj != null)
                        {
                                getEm().remove(obj);
                        }
                        return true;
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return false;
                }
        }

        /**
        * Override this if needed
        */
        protected T preDelete(T object)
        {
                return object;
        }

        ...</tt></pre>
</div></div>
<div class="paragraph"><p>Nel caso d&#8217;uso considerato, la gestione degli ordini puo' ad esempio richiedere una cancellazione di tipo solamente logico, realizzata impostando un apposito flag anziche' eliminando realmente il dato.</p></div>
<div class="paragraph"><p>La visualizzazione di un ordine puo' invece richiedere il caricamento degli articoli associati.</p></div>
<div class="listingblock">
<div class="title">OrderRepository</div>
<div class="content">
<pre><tt>        ...

        @Override
        protected Order preDelete(Order order) {
                order.setActive(false);
        }

        @Override
        public boolean delete(Object key) {
                try
                {
                        Order order = find(key);
                        order = preDelete(order);
                        return update(order);
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return false;
                }
        }

        ...

        @Override
        public Order fetch(Object key)
        {
                try
                {
                        return getEm().createQuery("select o from " + Order.class.getSimpleName() + " o left join fetch o.items i where o.id = :ID).setParameter("ID",key).getSingleResult();
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return null;
                }
        }

        ...</tt></pre>
</div></div>
<div class="paragraph"><p>Il <em>Controller</em> dedicato agli ordini puo' infine avvalersi delle logiche dell&#8217;armatura base di tipo <em>Repository</em> in fase di creazione, rilettura o modifica di un ordine.</p></div>
<div class="paragraph"><p>Grazie all&#8217;utilizzo dei tipi generici, anche tali operazioni possono essere implementate nell&#8217;armatura base di tale <em>Controller</em>, demandando alla specifica implementazione la sola iniezione
del <em>Repository</em> utilizzato.</p></div>
<div class="listingblock">
<div class="title">OrderController.java</div>
<div class="content">
<pre><tt>        ...

        @Inject
        @OwnRepository(OrderRepository.class)
        OrderRepository orderRepository;

        ...</tt></pre>
</div></div>
<div class="listingblock">
<div class="title">AbstractLazyController.java</div>
<div class="content">
<pre><tt>        ...

        private Class&lt;T&gt; entityClass;

        public String addElement()
        {
                this.element = getRepository().create(entityClass);
                ...
                return editPage();
        }

        public String save()
        {
                try
                {
                        // eventuale recupero e preelaborazioni dati in input nelle sottoclassi che estendono l'armatura
                        preSave();
                        // salvataggio
                        setElement(getRepository().persist(getElement()));
                        setElement(getRepository().fetch(getId(getElement())));
                        // refresh locale
                        ...
                        refreshModel();
                        resetEvent.fire(new ResetEvent(getClassType()));
                        return viewPage();
                }
                catch (Exception exc)
                {
                        return editPageNoRedirect();
                }
        }

        /**
        * Override this if needed
        */
        protected void preSave() throws Exception { }

        ...

        public String update()
        {
                try
                {
                        // eventuale recupero e preelaborazioni dati in input nelle sottoclassi che estendono l'armatura
                        preUpdate();
                        // salvataggio
                        getRepository().update(getElement());
                        // refresh locale
                        setElement(getRepository().fetch(getId(getElement())));
                        ...
                        refreshModel();
                        resetEvent.fire(new ResetEvent(getClassType()));
                        return viewPage();
                }
                catch (Exception exc)
                {
                        return editPageNoRedirect();
                }
        }

        /**
        * Override this if needed
        */
        protected void preUpdate() throws Exception { }

        ...</tt></pre>
</div></div>
<div class="paragraph"><p>Per ottenere tale risultato, l&#8217;armatura <em>Controller</em> generica fornisce inoltre numerosi metodi di utilita' per l&#8217;accesso al repository e alle caratteristiche del tipo di dato tratto, quali quelli di seguito riportati.</p></div>
<div class="listingblock">
<div class="title">AbstractLazyController.java</div>
<div class="content">
<pre><tt>        ...

        private Repository&lt;T&gt; repository;

        public Repository&lt;T&gt; getRepository()
        {
                return repository;
        }

        @PostConstruct
        private void init()
        {
                injectRepositoryAndPages();
                ...
        }

        @SuppressWarnings({ "rawtypes", "unchecked" })
        private void injectRepositoryAndPages()
        {
                Field[] fields = getClass().getDeclaredFields();
                for (Field field : fields)
                {
                        try
                        {
                                // recupero dei campi annotati con le nostre annotazioni
                                ...
                                OwnRepository repository_anno = field.getAnnotation(OwnRepository.class);
                                ...
                                if (repository_anno != null)
                                {
                                        Class clazz = repository_anno.value();
                                        this.repository = (Repository&lt;T&gt;) BeanUtils.getBean(clazz);
                                }
                        }
                        catch (Exception e)
                        {
                                logger.error(e.getMessage(),e);
                                e.printStackTrace();
                        }
                }
        }

        ...

        /**
         * Override this if needed
         */
        public Object getId(T t)
        {
                try
                {
                        Field f = t.getClass().getDeclaredField("id");
                        f.setAccessible(true);
                        return f.get(t);
                }
                catch (Exception e)
                {
                        // never happens
                        e.printStackTrace();
                        return null;
                }
        }</tt></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_logica_di_ricerca">Logica di ricerca</h3>
<div class="paragraph"><p>L&#8217;armatura generica, implementa i meccanismi basi per permettere un&#8217;efficiente ricerca filtrata in base ai campi di un oggetto di esempio <em>Search</em>.</p></div>
<div class="listingblock">
<div class="title">Search.java</div>
<div class="content">
<pre><tt>public class Search&lt;T&gt; implements Serializable {

        private static final long serialVersionUID = 1L;

        private Class&lt;T&gt; classType;

        // --------- Templating ----------------------------------------

        private T obj;
        private T from;
        private T to;
        private T like;

        // --------- Ordering ----------------------------------------

        private String defaultOrder;
        private String order;
        private boolean orderAsc = true;

        public Search(Class&lt;T&gt; t) {
                classType = t;
                this.obj = init(t);
                this.from = init(t);
                this.to = init(t);
        }

        private T init(Class&lt;T&gt; t) {
                try {
                        return t.newInstance();
                } catch (InstantiationException e) {
                        e.printStackTrace();
                        return null;
                } catch (IllegalAccessException e) {
                        e.printStackTrace();
                        return null;
                }
        }

        // getters and setters
        ...</tt></pre>
</div></div>
<div class="paragraph"><p>L&#8217;oggetto <em>Search</em> generico appena descritto viene valorizzato secondo necessita'.</p></div>
<div class="paragraph"><p>Ad esempio, tramite i campi di input dell&#8217;interfaccia web e il <em>Controller</em> del relativo tipo di dato.</p></div>
<div class="listingblock">
<div class="title">list.xhtml</div>
<div class="content">
<pre><tt>        ...

        &lt;ui:define name="content"&gt;

                &lt;h:form id="mainForm"&gt;

                        ...

                        &lt;h:outputLabel value="identificativo:"
                                for="identifier" /&gt;
                        &lt;h:inputText id="identifier" value="#{orderController.search.obj.id}" /&gt;

                        &lt;h:outputLabel for="dal" value="dal:" /&gt;
                        &lt;p:calendar id="dal"
                                value="#{orderController.search.from.data}"
                                title="Data dal" pattern="dd/MM/yyyy HH:mm" locale="it"
                                startWeekday="1" showOn="button" /&gt;

                        ...</tt></pre>
</div></div>
<div class="paragraph"><p>Inoltre, come gia' accennato nel post precedent, nel caso della ricerca a partire da interfaccia web il criterio di ricerca <em>Search</em> viene inizializzato nella specifica classe <em>Controller</em> di ogni tipo di dato tenendo conto della profilazione dell&#8217;utente corrente.</p></div>
<div class="listingblock">
<div class="title">OrderController.java</div>
<div class="content">
<pre><tt>        ...

        @Inject
        LoginController loginController;

        @Override
        public void defaultCriteria()
        {
                getSearch().getObj().setUser(loginController.getUser().getId());
                getSearch().getFrom().setData(ultimi6mesi());
        }

}</tt></pre>
</div></div>
<div class="paragraph"><p>La creazione vera e propria dell&#8217;oggetto <em>Search</em> avviene invece nell&#8217;armatura generica di tutti i <em>Controller</em>; i risultati della ricerca sono altresi' messi a disposizione da tale armatura tramite un oggetto JSF di tipo <em>DataModel</em> (nel caso mostrato, realizzato sulla base delle API di PrimeFaces, al fine di gestire la paginazione dei risultati).</p></div>
<div class="listingblock">
<div class="title">AbstractLazyController.java</div>
<div class="content">
<pre><tt>        ...

        private Class&lt;T&gt; entityClass;

        private Search&lt;T&gt; search;

        /**
         * Extending classes can only access and modify, not re-assign from scratch
         */
        public Search&lt;T&gt; getSearch()
        {
                return this.search;
        }

        @SuppressWarnings({ "unchecked", "rawtypes" })
        public AbstractLazyController()
        {
                this.entityClass = getClassType();
                // defaultCriteria();
                search = new Search(this.entityClass);
        }

        @SuppressWarnings({ "rawtypes", "unchecked" })
        private Class&lt;T&gt; getClassType()
        {
                Class clazz = getClass();
                while (!(clazz.getGenericSuperclass() instanceof ParameterizedType))
                {
                        clazz = clazz.getSuperclass();
                }
                ParameterizedType parameterizedType = (ParameterizedType) clazz
                       .getGenericSuperclass();
                return (Class&lt;T&gt;) parameterizedType.getActualTypeArguments()[0];
        }

        ...

        private LocalLazyDataModel&lt;T&gt; model;

        public LocalLazyDataModel&lt;T&gt; getModel()
        {
                if (model == null) {
                        refreshModel();
                }
                return model;
        }

        public void setModel(LocalLazyDataModel&lt;T&gt; model)
        {
                this.model = model;
        }

        public void refreshModel()
        {
                setModel(new LocalLazyDataModel&lt;T&gt;(search, getRepository()));
        }

        ...</tt></pre>
</div></div>
<div class="paragraph"><p>Laddove, la specifica implementazione del DataModel (in questo caso rispondente alle API previste da PrimeFaces), prevede la seguente struttura:</p></div>
<div class="listingblock">
<div class="title">LocalLazyDataModel.java</div>
<div class="content">
<pre><tt>public class LocalLazyDataModel&lt;T&gt; extends LazyDataModel&lt;T&gt; implements
         Serializable
{

        private static final long serialVersionUID = 1L;

        private List&lt;T&gt; list;
        private Search&lt;T&gt; search;
        private Repository&lt;T&gt; repository;

        ...

        public LocalLazyDataModel(Search&lt;T&gt; search, Repository&lt;T&gt; repository)
        {
                super();

                setRowCount(repository.getListSize(search));

                this.search = search;
                this.repository = repository;
        }

        ...

        public List&lt;T&gt; load(int first, int pageSize, String sortField,
        boolean sortOrder, Map&lt;String, String&gt; filters)
        {
                List&lt;T&gt; data = null;
                if (sortField != null &amp;&amp; sortField.trim().length() &gt; 0)
                {
                        search.setOrder(sortField);
                }
                search.setOrderAsc(sortOrder);
                data = repository.getList(search, first, pageSize);
                ...
                }
                return data;
        }

        ...</tt></pre>
</div></div>
<div class="paragraph"><p>L&#8217;armatura generica di tipo <em>Repository</em> implementa la logica di ricerca e filtraggio. Nel nostro caso, per praticita' di utilizzo, si e' scelto di rendere disponibile sia una implementazione tramite query EJBQL che mediante criteri JPA2.</p></div>
<div class="paragraph"><p>Nel seguito, viene riportata la prima.</p></div>
<div class="listingblock">
<div class="title">AbstractRepository.java</div>
<div class="content">
<pre><tt>        @SuppressWarnings("unchecked")
        public List&lt;T&gt; getList(Search&lt;T&gt; ricerca, int startRow, int pageSize)
        {
                try
                {
                        List&lt;T&gt; result = null;
                        boolean count = false;
                        Query res = getRestrictions(ricerca, count);
                        if (res == null) {
                                return result;
                        }
                        if (startRow &gt;= 0)
                        {
                                res.setFirstResult(startRow);
                        }
                        if (pageSize &gt; 0)
                        {
                                res.setMaxResults(pageSize);
                        }
                        result = (List&lt;T&gt;) res.getResultList();
                        return result == null ? new ArrayList&lt;T&gt;() : result;
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage(), e);
                        return new ArrayList&lt;T&gt;();
                }
        }

        public int getListSize(Search&lt;T&gt; ricerca)
        {
                try
                {
                        Long result = new Long(0);
                        boolean count = true;
                        Query res = getRestrictions(ricerca, count);
                        if ((res != null))
                        {
                                result = (Long) res.getSingleResult();
                        }
                        return result == null ? 0 : result.intValue();
                }
                catch (Exception e)
                {
                        logger.error(e.getMessage());
                        return 0;
                }
        }

        ...

        protected Query getRestrictions(Search&lt;T&gt; search, boolean justCount)
        {
                Map&lt;String, Object&gt; params = new HashMap&lt;String, Object&gt;();

                String alias = "c";
                StringBuffer sb = new StringBuffer(getBaseList(search.getObj().getClass(), alias, justCount));
                String separator = " where ";

                applyRestrictions(search, alias, separator, sb, params);

                if (!justCount)
                {
                        sb.append(getOrderBy(alias, search.getOrder()));
                }

                Query q = getEm().createQuery(sb.toString());
                for (String param : params.keySet())
                {
                        q.setParameter(param, params.get(param));
                }

                return q;
        }

        protected String getBaseList(Class&lt;? extends Object&gt; clazz, String alias, boolean count)
        {
                if (count)
                {
                        return "select count(" + alias + ") from " + clazz.getSimpleName()
                        + " " + alias + " ";
                }
                else
                {
                        return "select " + alias + " from " + clazz.getSimpleName() + " "
                        + alias + " ";
                }
        }

        protected void applyRestrictions(Search&lt;T&gt; search, String alias,
            String separator, StringBuffer sb, Map&lt;String, Object&gt; params)
        {
        }

        ...</tt></pre>
</div></div>
<div class="paragraph"><p>Ogni specifico <em>Repository</em> puo' infine arricchire i criteri di filtro, in base a quanto richiesto dall&#8217;applicazione.</p></div>
<div class="listingblock">
<div class="title">OrderRepository.java</div>
<div class="content">
<pre><tt>        ...

        @Override
        protected void applyRestrictions(Search&lt;SentFax&gt; search, String alias,
                String separator, StringBuffer sb, Map&lt;String, Object&gt; params)
        {

                ...

                if (search.getObj().getId() != null )
                {
                        sb.append(separator).append(alias).append(".id = :ID_EQ ");
                        params.put("ID_EQ", search.getObj().getId());
                        separator = " and ";
                }

                if (search.getFrom().getData() != null)
                {
                        sb.append(separator).append(alias).append(".data &gt;= :DATA_FROM ");
                        params.put("DATA_FROM", search.getFrom().getStartDate());
                        separator = " and ";
                }

                ...
      }</tt></pre>
</div></div>
<div class="paragraph"><p>Tale meccanismo permette con semplicita' di realizzare politiche di filtro anche complesse e articolate.</p></div>
<div class="paragraph"><p>Ad esempio, per mostrare a un operatore-supervisore abilitato a operare in piu' filiali
 tutti gli ordini gestiti da lui stesso e dagli operatori a lui sottoposti in tali filiali,
insieme ai soli ordini associati alla filiale principale e da lui direttamente gestiti&#8230;</p></div>
<div class="listingblock">
<div class="title">OrderReportController.java</div>
<div class="content">
<pre><tt>        ...

        @Inject
        LoginController loginController;

        @Override
        public void defaultCriteria()
        {
                // set dei criteri di filtro in campi transienti
                getSearch().getObj().setSearchForOperators(loginController.getManagedOperators());
                getSearch().getObj().setSearchForDepartments(loginController.getManagedDepartments());
        }

}</tt></pre>
</div></div>
<div class="listingblock">
<div class="title">OrderRepository.java</div>
<div class="content">
<pre><tt>        ...

        @Override
        protected void applyRestrictions(Search&lt;SentFax&gt; search, String alias,
                String separator, StringBuffer sb, Map&lt;String, Object&gt; params)
        {

                ...

                if (search.getObj().getSearchForOperators() != null &amp;&amp; search.getObj().getSearchForOperators().size() &gt; 0)
                {
                        sb.append(separator).append(alias).append(".operator in ( :OPERATORS ) ");
                        params.put("OPERATORS", search.getObj().getRicercaOperators());
                        separator = " and ";
                }

                // ACCOUNTS
                if (search.getObj().getSearchForDepartments() != null &amp;&amp; search.getObj().getSearchForDepartments.size() &gt; 0)
                {
                        List&lt;Long&gt; depIds = new ArrayList&lt;Long&gt;();
                        for ( Department department : search.getObj().getSearchForDepartments() ) {
                                depIds.add(department.getId());
                        }

                        sb.append(separator).append(" ( ");

                        sb.append(" ( ").append(alias).append(".deparment.id in ( :DEP_IDS ) ) ");

                        sb.append(" or ");

                        sb.append(" ( ").append(alias).append(".department.defaultDepartment = :DEFAULT_DEP ");
                        sb.append(" and ")
                             .append(alias).append(".operator = :DEFAULT_OPERATOR ");
                        sb.append(" ) ");

                        sb.append(" ) ");

                        params.put("DEP_IDS", depIds);
                        params.put("DEFAULT_DEP", true);
                        params.put("DEFAULT_OPERATOR", ctx.getCallerPrincipal().getName());

                        separator = " and ";

                }

                ...
      }</tt></pre>
</div></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-08-14 09:20:30 CEST
</div>
</div>
</body>
</html>
